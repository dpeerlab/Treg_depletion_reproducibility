#/lila/data/peer/tinyi/rudenska/scRNA/formatted_exp2

#### load libraries ####

library(Matrix)
library(BayesPrism)
library(readr)
library(BiocParallel)

#### load data ####

# load the full data object
## this load function contains objects:
#' ref.dat.filtered = cell x gene expression matrix
#' meta = metadata for cells in the expression matrix including cell type labels and sub-state labels
load("/data/peer/sam/treg_dep/mouse/data/scrna.herman.raw.newAnnot.rdata")

# create unique barcode index for cells
uniq_index = make.unique(rownames(ref.dat), sep = "-")
# filter out gene names that are empty
ref.dat = ref.dat[,colnames(ref.dat) != ""]
rownames(ref.dat) = uniq_index

# filter out columns that can't be mapped
ref.dat = ref.dat[,colnames(ref.dat) %in% rownames(gene.annot.matched)]

# change to gene symbol
colnames(ref.dat) = gene.annot.matched[match(colnames(ref.dat), gene.annot.matched$`Ensembl Gene`), 'gene_id'] %>% stringr::str_to_title()

# set uniq index for metadata
rownames(meta) = uniq_index


#filter out Treg in DT

filter.idx <- ! (meta$celltype=="Treg" & meta$condition=="DT")

meta <- meta[filter.idx,]
ref.dat <- ref.dat[filter.idx,]

tot.umi <- apply(ref.dat,1,sum)

# library size filtering
umi.filter.idx <- (meta$minor_lineage=="T cell" & tot.umi < 2000) | tot.umi < 1000

meta <- meta[!umi.filter.idx,]
ref.dat <- ref.dat[!umi.filter.idx,]




#re-define cell type labels by grouping similar cell types (adapted from original)
#very coarse:
very_coarse_consolidation = list(
  'AT1' = 'AT1',
  'AT2' = 'AT2',
  'Tumor' = 'Tumor',
  'Plvap+ capillary'=c('Artery/Vein','Plvap+ capillary'),
  'Car4+ capillary'= c('Inflammatory capillary','Car4+ capillary'),
  'Lymphatic endothelial'=  c('Lymphatic endothelial'),
  'Fibroblast'= c('Col13a1+ fibroblast','Col14a1+ fibroblast','Pericyte',
                  'Myofibroblast','Mesothelial','MSC'),
  'T cell'=c('Activated T','CD8+ T','Cycling T','Effector T','Exhausted CD8+ T',
             'MAIT','Naive T','Th2','gdT'),
  'Treg'=('Treg'),
  'ILC2'= c('ILC2'),
  'NK'= c('NK'),
  'B cell'= c('B cell','Plasma cell'),
  'Alveolar macrophage'= c('Alveolar macrophage'),
  'Monocyte/Macrophage/DC'= c('Arg1+ macrophage','C1qa+ macrophage',
                              'Csf3r+ monocyte','Monocyte','cDC1','cDC2','Ccr7+ cDC2','pDC'),
  'Neutrophil'= c('Csf3r+ neutrophil','Ccl3+ neutrophil','Siglecf+ neutrophil'),
  'Skeletal muscle cell'= c('Skeletal muscle cell'), # small distinct population
  'Basophil'= c('Basophil'), # small distinct population
  'Platelet'= c('Platelet'), # small distinct population
  'Ciliated'= c('Ciliated') # small distinct population
)

## vI, iterative version (used for marker gene selection)
very_coarse_consolidation_ct = list(
  'AT1' = 'AT1',
  'AT2' = 'AT2',
  'Tumor' = 'Tumor',
  'Plvap+ capillary'=c('Artery/Vein','Plvap+ capillary'),
  'Car4+ capillary'= c('Car4+ capillary', 'Inflammatory capillary'),
  #'Car4+ capillary'= c('Car4+ capillary'),
  #'Inflammatory capillary' = 'Inflammatory capillary',
  #'Inflammatory capillary' = 'Inflammatory capillary',
  'Lymphatic endothelial'=  'Lymphatic endothelial',
  'Col13a1+ fibroblast' = 'Col13a1+ fibroblast', 
  'Col14a1+ fibroblast' = 'Col14a1+ fibroblast',
  'Pericyte' = 'Pericyte',
  'Myofibroblast' = 'Myofibroblast',
  'Mesothelial' = 'Mesothelial',
  'MSC' = 'MSC',
  #'Activated T' = 'Activated T', 
  'T cell/ILC2' = c('CD8+ T', 'Effector T','Exhausted CD8+ T',
                    'MAIT', 'gdT', 'Th2', 'Naive T', 'Activated T', 'Treg', 
                    'ILC2'), 
  'Cycling T' = 'Cycling T',
  'NK'= c('NK'),
  'B cell'= c('B cell', 'Plasma cell'),
  'Alveolar macrophage'= c('Alveolar macrophage'),
  #'Arg1+ macrophage' = 'Arg1+ macrophage', 
  #'C1qa+ macrophage' = 'C1qa+ macrophage', 
  'Macrophage' = c('Arg1+ macrophage', 'C1qa+ macrophage'),
  'Monocyte' = c('Monocyte', 'Csf3r+ monocyte'),
  #'Mo/Mac' = c('Monocyte', 'Csf3r+ monocyte', 
  #             'Arg1+ macrophage', 'C1qa+ macrophage'),
  'cDC' = c('cDC1', 'cDC2'),
  #'cDC1' = 'cDC1', 
  #'cDC2' = 'cDC2',
  'Ccr7+ cDC2' = 'Ccr7+ cDC2',
  'pDC' = 'pDC',
  'Neutrophil'= c('Csf3r+ neutrophil','Ccl3+ neutrophil','Siglecf+ neutrophil'),
  'Skeletal muscle cell'= c('Skeletal muscle cell'), # small distinct population
  'Basophil'= c('Basophil'), # small distinct population
  'Platelet'= c('Platelet'), # small distinct population
  'Ciliated'= c('Ciliated') # small distinct population
)


# creating new labels for marking which cell types should get DT and control states
cell.type.labels <- as.character(meta$celltype)
cell.lineage.labels <- rep(NA,length(cell.type.labels))
cell.annot.labels <- rep(NA,length(cell.type.labels))

for(idx in 1:length(very_coarse_consolidation)){
  cell.lineage.labels[cell.type.labels %in% very_coarse_consolidation[[idx]] ] <- names(very_coarse_consolidation)[idx]
}

for(idx in 1:length(very_coarse_consolidation_ct)){
  cell.annot.labels[cell.type.labels %in% very_coarse_consolidation_ct[[idx]] ] <- names(very_coarse_consolidation_ct)[idx]
}


# specifying which cell types will get different states based on condition
#change this to be more granular
similar = c(
  'T cell/ILC2',
  'NK','B cell',  'Cycling T',
  'Skeletal muscle cell','Basophil','Platelet','Ciliated', 'MSC', 'Mesothelial',
  'Col13a1+ fibroblast', 'Col14a1+ fibroblast', 'Pericyte', 'Myofibroblast',
  'Ccr7+ cDC2', 'pDC')
different= c('Car4+ capillary',
             'Col13a1+ fibroblast', 'Col14a1+ fibroblast', 'Pericyte', 'Myofibroblast',
             'cDC',
             'Alveolar macrophage', 
             #'Mo/Mac',
             #'Arg1+ macrophage', 'C1qa+ macrophage', 
             'Macrophage',
             'Neutrophil', 
             'Plvap+ capillary','Lymphatic endothelial', 'AT1', 'AT2', 
             'Monocyte'
)



condition.labels <- as.character(meta$condition)
#condition.labels[cell.lineage.labels %in% similar] <- "merged"
condition.labels[cell.annot.labels %in% similar] <- "merged"

table(cbind.data.frame(condition.labels, cell.type.labels))



cell.subtype.labels <- paste(condition.labels, cell.annot.labels,sep="-")

## remove particular cell types from reference
rm.cell.idx = cell.subtype.labels == "merged-Cycling T"

cell.subtype.labels = cell.subtype.labels[!(rm.cell.idx)]
cell.annot.labels = cell.annot.labels[!(rm.cell.idx)]
cell.lineage.labels = cell.lineage.labels[!(rm.cell.idx)]

ref.dat = ref.dat[!(rm.cell.idx),]

source("/data/peer/sam/treg_dep/scripts/visium/for_sam/get_signature_geneV4.6_revised.R")

# get set of genes to filter out of marker gene computation
gene_counts = readRDS(file = '/data/peer/sam/treg_dep/visium/data/requant/processed/gene_counts_visium_merged_quant2_20220829.rds')
gene_exp = names(gene_counts)[gene_counts >= 10]

# get mouse genes
gene.list <- read.table(system.file("extdata", "genelist.mm.new.txt", 
                                    package = "BayesPrism"), sep = "\t", header = F, 
                        stringsAsFactors = F)
gene_rm = gene.list %>% dplyr::filter(V1 %in% c('other_Rb', 'Rb', 'chrM', 'Mrp')) %>% .$V3

# genes to use for marker gene selection, with rb, Mt, and genes not captured in visium removed
gene_keep = colnames(ref.dat)[colnames(ref.dat) %in% gene_exp & !(colnames(ref.dat) %in% gene_rm)]


# function to do pairwise T tests to compute marker genes
gene.stats <- get.genes.statistics (ref.dat= ref.dat,
                                    #subset.genes= colnames(ref.dat),
                                    subset.genes= gene_keep,
                                    cell.type.labels= cell.annot.labels,
                                    cell.subtype.labels= cell.subtype.labels,
                                    cell.count.cutoff=25,
                                    n.cores= 40,
                                    psuedo.count= 0.1)


# marker gene selection thresholds
pval.up.cut <- 0.05
lfc.cut <- 0.25

exp.cut <- 1

ct.stat.list.filtered <- lapply(gene.stats,function(df.i){
  
  df.i.filtered <- df.i[df.i$pval.up.min < pval.up.cut & 
                          #df.i $pval.down.min > pval.down.cut & 
                          df.i$ min.lfc > lfc.cut,,drop=F]
  
  df.i.filtered <- df.i.filtered[df.i.filtered$exp.max < quantile(df.i.filtered $exp.ct, probs= exp.cut), ,drop=F]
  # filter genes that are expressed above a certain amount if I want
  
})

# how many marker genes for each cell type?
lapply(ct.stat.list.filtered, nrow) %>% reshape2::melt() %>% arrange(desc(value))

# write out gene stats
saveRDS(ct.stat.list.filtered, file = "/data/peer/sam/treg_dep/visium/results/bayesprism/celltype_markerGenes_filtered_deconvRiter1_20220824.rds")

sig.genes <- unique(unlist(lapply(ct.stat.list.filtered,rownames)))

# filter out cell cycle genes from the significant genes
cc_genes = read.csv('/data/peer/sam/ref_data/gene_sets/CRC-22-Ganesh_1.0_SPECTRA_genesetsxgenes_cellcycle.csv') %>%
  mutate(gene_mouse = stringr::str_to_title(g.name))
sig.genes = sig.genes[!(sig.genes %in% cc_genes$gene_mouse)]


meta = meta[!(rm.cell.idx),]

meta$cell.subtype.labels <- cell.subtype.labels
meta$cell.lineage.labels <- cell.lineage.labels
meta$cell.annot.labels <- cell.annot.labels

ref.dat.sig <- ref.dat[, sig.genes]


ref.dat.filtered <- BayesPrism::cleanup.genes(input = ref.dat.sig,  input.type = "count.matrix",
                                              species="mm", gene.group=c("Rb","chrM"), exp.cells=5) 



save(ref.dat.filtered, meta, ct.stat.list.filtered, file="/data/peer/sam/treg_dep/mouse/data/scrna.herman.allCT.deconvRiter1.pUp0.05.rdata")

# write out the list of genes so that I can use it with cell2location
write.csv(sig.genes, file = "/data/peer/sam/treg_dep/mouse/data/sig_genes.deconvRiter1.pUp0.05.csv", quote = F, row.names = F)

# example output
#str(ct.stat.list.filtered)
# List of 44
# $ Pericyte              :'data.frame': 152 obs. of  5 variables:
# ..$ pval.up.min: num [1:152] 4.69e-02 7.74e-02 1.39e-03 2.35e-07 4.15e-09 ...
# ..$ min.lfc    : num [1:152] 0.0401 0.0686 0.0416 0.4884 0.0601 ...
# ..$ exp.max    : num [1:152] 0.744 0.557 0.414 4.783 0.148 ...
# ..$ exp.ct     : num [1:152] 0.924 0.709 0.734 1.85 0.361 ...
# ..$ fract.ct   : num [1:152] 4.26e-05 3.28e-05 2.77e-05 1.20e-04 1.49e-05 ...
# $ Col14a1+ fibroblast   :'data.frame': 132 obs. of  5 variables:
# ..$ pval.up.min: num [1:132] 0.02864 0.001765 0.000018 0.00112 0.084024 ...
# ..$ min.lfc    : num [1:132] 0.0854 0.1311 0.2196 0.0481 0.0197 ...
# ..$ exp.max    : num [1:132] 0.1101 2.136 1.3781 0.3656 0.0153 ...
# ..$ exp.ct     : num [1:132] 0.2242 2.7815 2.0169 0.2385 0.0519 ...
# ..$ fract.ct   : num [1:132] 9.77e-06 1.72e-04 1.36e-04 1.11e-05 1.95e-06 ...
# $ Myofibroblast         :'data.frame': 94 obs. of  5 variables:
# ..$ pval.up.min: num [1:94] 1.75e-07 1.12e-24 1.39e-07 5.83e-15 1.68e-04 ...
# ..$ min.lfc    : num [1:94] 0.2399 1.0745 0.0716 0.5664 0.2818 ...
# ..$ exp.max    : num [1:94] 0.0297 0.272 3.4272 0.3859 2.9289 ...
# ..$ exp.ct     : num [1:94] 0.324 1.688 4.522 1.47 3.549 ...
# ..$ fract.ct   : num [1:94] 1.84e-05 1.01e-04 2.02e-03 2.18e-04 4.18e-04 ...
# $ Col13a1+ fibroblast   :'data.frame': 212 obs. of  5 variables:
# ..$ pval.up.min: num [1:212] 2.94e-03 5.87e-03 1.55e-08 1.11e-05 6.60e-05 ...
# ..$ min.lfc    : num [1:212] 0.0289 0.0778 0.1661 0.0315 0.0593 ...
# ..$ exp.max    : num [1:212] 0.6506 0.8948 0.9545 0.0106 0.9843 ...
# ..$ exp.ct     : num [1:212] 0.841 1.379 1.764 0.286 1.548 ...
# ..$ fract.ct   : num [1:212] 2.40e-05 5.11e-05 1.11e-04 1.37e-05 8.43e-05 ...
# $ Mesothelial           :'data.frame': 222 obs. of  5 variables:
# ..$ pval.up.min: num [1:222] 1.45e-05 4.89e-02 5.95e-02 1.43e-04 9.70e-03 ...
# ..$ min.lfc    : num [1:222] 0.29 0.13 0.259 0.164 0.242 ...
# ..$ exp.max    : num [1:222] 0.09816 0.08715 1.26995 0.00783 1.52144 ...
# ..$ exp.ct     : num [1:222] 0.551 0.212 1.495 0.324 1.982 ...
# ..$ fract.ct   : num [1:222] 2.68e-05 1.16e-05 7.33e-05 1.38e-05 1.44e-04 ...
# $ MSC                   :'data.frame': 860 obs. of  5 variables:
# ..$ pval.up.min: num [1:860] 4.77e-02 1.37e-05 2.08e-02 2.16e-02 6.04e-02 ...
# ..$ min.lfc    : num [1:860] 0.256 0.578 0.134 0.552 0.191 ...
# ..$ exp.max    : num [1:860] 0.483 0.849 0.242 1.576 0.431 ...
# ..$ exp.ct     : num [1:860] 0.739 1.337 0.293 2.128 0.622 ...
# ..$ fract.ct   : num [1:860] 3.69e-05 7.75e-05 1.37e-05 1.49e-04 2.79e-05 ...
# $ Csf3r+ monocyte       :'data.frame': 106 obs. of  5 variables:
# ..$ pval.up.min: num [1:106] 3.85e-02 5.43e-05 8.63e-03 6.88e-02 6.28e-02 ...
# ..$ min.lfc    : num [1:106] 0.146 0.266 0.142 0.243 0.117 ...
# ..$ exp.max    : num [1:106] 0.839 0.82 1.502 2.021 0.613 ...
# ..$ exp.ct     : num [1:106] 0.724 1.594 1.701 2.29 0.742 ...
# ..$ fract.ct   : num [1:106] 2.87e-05 5.84e-05 8.16e-05 1.21e-04 3.17e-05 ...
# $ Monocyte              :'data.frame': 33 obs. of  5 variables:
# ..$ pval.up.min: num [1:33] 8.43e-03 1.11e-02 8.32e-03 1.57e-05 4.41e-05 ...
# ..$ min.lfc    : num [1:33] 0.1766 0.1678 0.19 0.1799 0.0252 ...
# ..$ exp.max    : num [1:33] 1.172 1.298 1.81 1.813 0.923 ...
# ..$ exp.ct     : num [1:33] 1.46 1.73 2.06 1.88 1.33 ...
# ..$ fract.ct   : num [1:33] 7.22e-05 8.69e-05 1.16e-04 9.47e-05 6.22e-05 ...
# $ cDC2                  :'data.frame': 77 obs. of  5 variables:
# ..$ pval.up.min: num [1:77] 6.36e-02 4.19e-04 6.72e-04 5.73e-02 1.91e-05 ...
# ..$ min.lfc    : num [1:77] 0.0586 0.4513 0.2079 0.0665 0.0364 ...
# ..$ exp.max    : num [1:77] 0.507 2.973 0.56 0.478 0.421 ...
# ..$ exp.ct     : num [1:77] 0.127 2.662 0.414 0.627 0.372 ...
# ..$ fract.ct   : num [1:77] 5.23e-06 1.99e-04 2.20e-05 2.41e-05 1.11e-05 ...
# $ Alveolar macrophage   :'data.frame': 328 obs. of  5 variables:
# ..$ pval.up.min: num [1:328] 8.26e-11 6.30e-06 1.30e-05 5.63e-04 8.81e-02 ...
# ..$ min.lfc    : num [1:328] 0.5085 0.1554 0.1005 0.1121 0.0526 ...
# ..$ exp.max    : num [1:328] 0.3343 0.133 0.0159 1.0816 0.1072 ...
# ..$ exp.ct     : num [1:328] 0.786 0.315 0.118 0.891 0.172 ...
# ..$ fract.ct   : num [1:328] 3.54e-05 1.21e-05 5.03e-06 3.51e-05 7.28e-06 ...
# $ Arg1+ macrophage      :'data.frame': 24 obs. of  5 variables:
# ..$ pval.up.min: num [1:24] 2.64e-02 7.61e-03 1.92e-05 1.13e-05 6.42e-02 ...
# ..$ min.lfc    : num [1:24] 0.15 0.302 0.326 0.529 0.042 ...
# ..$ exp.max    : num [1:24] 0.375 3.324 3.263 2.395 3.034 ...
# ..$ exp.ct     : num [1:24] 0.541 3.261 3.808 3.147 2.643 ...
# ..$ fract.ct   : num [1:24] 2.45e-05 2.45e-04 4.45e-04 2.18e-04 1.51e-04 ...
# $ C1qa+ macrophage      :'data.frame': 79 obs. of  5 variables:
# ..$ pval.up.min: num [1:79] 2.13e-04 1.56e-02 7.51e-12 3.07e-09 5.03e-03 ...
# ..$ min.lfc    : num [1:79] 0.1386 0.1932 1.0951 0.7687 0.0778 ...
# ..$ exp.max    : num [1:79] 1.458 1.065 1.627 4.902 0.378 ...
# ..$ exp.ct     : num [1:79] 0.59 0.831 2.88 4.973 0.61 ...
# ..$ fract.ct   : num [1:79] 1.98e-05 3.35e-05 1.75e-04 7.39e-04 2.05e-05 ...
# $ cDC1                  :'data.frame': 169 obs. of  5 variables:
# ..$ pval.up.min: num [1:169] 1.31e-03 4.52e-03 5.46e-11 2.91e-02 8.20e-05 ...
# ..$ min.lfc    : num [1:169] 0.68 0.557 0.807 0.361 0.116 ...
# ..$ exp.max    : num [1:169] 0.22 1.458 3.844 1.138 0.259 ...
# ..$ exp.ct     : num [1:169] 0.963 1.248 4.491 1.689 0.976 ...
# ..$ fract.ct   : num [1:169] 4.54e-05 5.00e-05 3.74e-04 7.68e-05 2.41e-05 ...
# $ Ccr7+ cDC2            :'data.frame': 171 obs. of  5 variables:
# ..$ pval.up.min: num [1:171] 9.57e-02 5.65e-03 6.90e-05 3.50e-06 2.69e-03 ...
# ..$ min.lfc    : num [1:171] 0.0335 0.3559 1.1254 1.3921 0.2342 ...
# ..$ exp.max    : num [1:171] 0.171 0.579 0.279 0.451 0.493 ...
# ..$ exp.ct     : num [1:171] 0.507 0.573 2.013 1.907 1.145 ...
# ..$ fract.ct   : num [1:171] 1.36e-05 2.52e-05 8.15e-05 9.32e-05 4.85e-05 ...
# $ pDC                   :'data.frame': 138 obs. of  5 variables:
# ..$ pval.up.min: num [1:138] 0.07376 0.04366 0.00358 0.02301 0.02106 ...
# ..$ min.lfc    : num [1:138] 0.1886 0.0346 0.7083 0.4929 0.5151 ...
# ..$ exp.max    : num [1:138] 0.3437 0.0833 1.9927 2.4477 0.5729 ...
# ..$ exp.ct     : num [1:138] 0.653 0.545 2.892 1.894 0.579 ...
# ..$ fract.ct   : num [1:138] 3.07e-05 1.53e-05 1.96e-04 8.89e-05 2.76e-05 ...
# $ gdT                   :'data.frame': 46 obs. of  5 variables:
# ..$ pval.up.min: num [1:46] 0.06455 0.08404 0.0016 0.08362 0.00712 ...
# ..$ min.lfc    : num [1:46] 0.1051 0.1471 0.4821 0.0703 0.2975 ...
# ..$ exp.max    : num [1:46] 0.3216 0.5135 4.5478 0.0726 0.6661 ...
# ..$ exp.ct     : num [1:46] 0.274 0.359 3.679 0.143 0.964 ...
# ..$ fract.ct   : num [1:46] 2.07e-05 3.32e-05 4.78e-04 1.35e-05 8.40e-05 ...
# $ MAIT                  :'data.frame': 24 obs. of  5 variables:
# ..$ pval.up.min: num [1:24] 4.23e-02 2.06e-03 9.68e-05 2.72e-02 7.40e-02 ...
# ..$ min.lfc    : num [1:24] 0.0976 0.2137 0.1505 0.2026 0.0697 ...
# ..$ exp.max    : num [1:24] 0.1449 0.2048 0.0559 4.5167 0.1873 ...
# ..$ exp.ct     : num [1:24] 0.242 0.418 0.206 4.719 0.203 ...
# ..$ fract.ct   : num [1:24] 1.74e-05 4.22e-05 1.68e-05 6.80e-04 1.49e-05 ...
# $ CD8+ T                :'data.frame': 7 obs. of  5 variables:
# ..$ pval.up.min: num [1:7] 7.25e-03 4.27e-02 1.25e-08 9.64e-02 8.19e-03 ...
# ..$ min.lfc    : num [1:7] 0.1002 0.0397 0.7741 0.0809 0.3787 ...
# ..$ exp.max    : num [1:7] 0.0724 0.0912 3.3837 0.6202 3.4122 ...
# ..$ exp.ct     : num [1:7] 0.1726 0.0589 3.8598 0.3779 3.7788 ...
# ..$ fract.ct   : num [1:7] 1.06e-05 4.49e-06 4.04e-04 2.61e-05 4.34e-04 ...
# $ Th2                   :'data.frame': 25 obs. of  5 variables:
# ..$ pval.up.min: num [1:25] 0.00501 0.05336 0.012276 0.087038 0.000381 ...
# ..$ min.lfc    : num [1:25] 0.2337 0.0342 0.2884 0.1427 0.4866 ...
# ..$ exp.max    : num [1:25] 0.855 0.021 1.254 0.974 3.391 ...
# ..$ exp.ct     : num [1:25] 1.0882 0.0551 1.1991 0.8231 3.8773 ...
# ..$ fract.ct   : num [1:25] 1.02e-04 3.76e-06 9.95e-05 5.88e-05 5.40e-04 ...
# $ ILC2                  :'data.frame': 39 obs. of  5 variables:
# ..$ pval.up.min: num [1:39] 7.71e-06 2.10e-03 4.48e-03 2.70e-02 4.15e-28 ...
# ..$ min.lfc    : num [1:39] 0.239 0.101 0.334 0.322 2.439 ...
# ..$ exp.max    : num [1:39] 0.1102 0.0119 1.6708 2.1058 1.2027 ...
# ..$ exp.ct     : num [1:39] 0.274 0.112 1.267 1.663 3.642 ...
# ..$ fract.ct   : num [1:39] 2.10e-05 7.87e-06 1.12e-04 1.42e-04 1.63e-03 ...
# $ NK                    :'data.frame': 65 obs. of  5 variables:
# ..$ pval.up.min: num [1:65] 2.95e-02 5.61e-04 2.15e-02 9.32e-02 3.89e-08 ...
# ..$ min.lfc    : num [1:65] 0.0644 0.3001 0.2603 0.1376 1.4619 ...
# ..$ exp.max    : num [1:65] 0.1166 0.0931 1.3875 0.6819 6.2119 ...
# ..$ exp.ct     : num [1:65] 0.116 0.393 0.829 0.742 7.674 ...
# ..$ fract.ct   : num [1:65] 8.11e-06 3.14e-05 6.74e-05 5.88e-05 4.93e-03 ...
# $ Activated T           :'data.frame': 188 obs. of  5 variables:
# ..$ pval.up.min: num [1:188] 0.02126 0.02694 0.03037 0.07564 0.00749 ...
# ..$ min.lfc    : num [1:188] 0.491 0.41 0.377 0.286 0.556 ...
# ..$ exp.max    : num [1:188] 0.552 0.402 0.181 0.258 3.128 ...
# ..$ exp.ct     : num [1:188] 0.864 0.672 0.557 0.445 3.684 ...
# ..$ fract.ct   : num [1:188] 6.51e-05 5.01e-05 3.51e-05 3.51e-05 4.56e-04 ...
# $ Effector T            :'data.frame': 2 obs. of  5 variables:
# ..$ pval.up.min: num [1:2] 0.00337 0.08576
# ..$ min.lfc    : num [1:2] 0.348 0.0506
# ..$ exp.max    : num [1:2] 1.674 0.229
# ..$ exp.ct     : num [1:2] 2.022 0.142
# ..$ fract.ct   : num [1:2] 1.97e-04 1.08e-05
# $ Naive T               :'data.frame': 136 obs. of  5 variables:
# ..$ pval.up.min: num [1:136] 1.27e-03 5.85e-04 1.42e-05 7.14e-06 2.42e-58 ...
# ..$ min.lfc    : num [1:136] 0.287 0.208 0.466 0.817 1.609 ...
# ..$ exp.max    : num [1:136] 1.497 0.393 5.447 2.012 1.077 ...
# ..$ exp.ct     : num [1:136] 1.089 0.433 5.913 2.558 1.952 ...
# ..$ fract.ct   : num [1:136] 9.50e-05 2.92e-05 1.01e-03 2.17e-04 2.39e-04 ...
# $ Exhausted CD8+ T      :'data.frame': 25 obs. of  5 variables:
# ..$ pval.up.min: num [1:25] 3.94e-02 1.85e-19 2.94e-13 1.62e-03 2.76e-02 ...
# ..$ min.lfc    : num [1:25] 0.149 1.511 1.314 0.277 0.219 ...
# ..$ exp.max    : num [1:25] 0.899 1.934 2.675 0.541 0.987 ...
# ..$ exp.ct     : num [1:25] 0.368 3.445 3.989 0.818 1.206 ...
# ..$ fract.ct   : num [1:25] 3.67e-05 4.86e-04 7.54e-04 5.38e-05 9.98e-05 ...
# $ Cycling T             :'data.frame': 413 obs. of  5 variables:
# ..$ pval.up.min: num [1:413] 9.30e-02 5.66e-02 9.99e-05 1.25e-30 6.97e-02 ...
# ..$ min.lfc    : num [1:413] 0.246 0.134 0.277 2.181 0.119 ...
# ..$ exp.max    : num [1:413] 1.4919 0.5809 0.3444 1.4028 0.0903 ...
# ..$ exp.ct     : num [1:413] 1.106 0.5 0.371 3.584 0.209 ...
# ..$ fract.ct   : num [1:413] 5.83e-05 2.51e-05 2.04e-05 5.81e-04 8.53e-06 ...
# $ Treg                  :'data.frame': 58 obs. of  5 variables:
# ..$ pval.up.min: num [1:58] 6.24e-02 6.02e-03 1.75e-02 2.03e-11 3.26e-02 ...
# ..$ min.lfc    : num [1:58] 0.249 0.545 0.426 1.072 0.309 ...
# ..$ exp.max    : num [1:58] 1.162 3.768 2.063 4.207 0.939 ...
# ..$ exp.ct     : num [1:58] 1.24 4.31 1.77 5.28 1.25 ...
# ..$ fract.ct   : num [1:58] 0.000111 0.000918 0.000188 0.001015 0.000127 ...
# $ Lymphatic endothelial :'data.frame': 189 obs. of  5 variables:
# ..$ pval.up.min: num [1:189] 2.96e-03 1.57e-03 2.43e-07 2.81e-03 2.69e-02 ...
# ..$ min.lfc    : num [1:189] 0.2837 0.3801 0.4477 0.275 0.0521 ...
# ..$ exp.max    : num [1:189] 0.454 1.712 0.245 0.585 0.049 ...
# ..$ exp.ct     : num [1:189] 0.621 1.681 0.564 0.86 0.101 ...
# ..$ fract.ct   : num [1:189] 4.27e-05 1.44e-04 4.25e-05 6.42e-05 6.26e-06 ...
# $ Car4+ capillary       :'data.frame': 247 obs. of  5 variables:
# ..$ pval.up.min: num [1:247] 5.15e-03 5.47e-05 3.51e-02 9.48e-09 1.06e-05 ...
# ..$ min.lfc    : num [1:247] 0.188 0.43 0.123 0.708 0.578 ...
# ..$ exp.max    : num [1:247] 0.388 1.648 0.307 1.214 0.575 ...
# ..$ exp.ct     : num [1:247] 0.625 2.435 0.551 2.01 1.393 ...
# ..$ fract.ct   : num [1:247] 7.75e-05 3.38e-04 5.54e-05 3.12e-04 1.52e-04 ...
# $ Plvap+ capillary      :'data.frame': 55 obs. of  5 variables:
# ..$ pval.up.min: num [1:55] 2.50e-04 1.33e-02 6.84e-02 2.15e-02 1.53e-05 ...
# ..$ min.lfc    : num [1:55] 0.668 0.206 0.104 0.443 0.59 ...
# ..$ exp.max    : num [1:55] 2.112 0.774 0.346 2.284 0.406 ...
# ..$ exp.ct     : num [1:55] 2.422 0.981 0.449 2.727 0.995 ...
# ..$ fract.ct   : num [1:55] 3.69e-04 8.74e-05 3.64e-05 3.34e-04 1.28e-04 ...
# $ Inflammatory capillary:'data.frame': 167 obs. of  5 variables:
# ..$ pval.up.min: num [1:167] 1.12e-05 5.00e-02 6.11e-02 6.83e-02 8.84e-02 ...
# ..$ min.lfc    : num [1:167] 1.082 0.128 0.177 0.178 0.192 ...
# ..$ exp.max    : num [1:167] 0.7984 0.0232 0.3945 0.1922 0.3064 ...
# ..$ exp.ct     : num [1:167] 1.481 0.151 0.3 0.366 0.499 ...
# ..$ fract.ct   : num [1:167] 2.15e-04 1.21e-05 2.72e-05 3.32e-05 4.53e-05 ...
# $ Artery/Vein           :'data.frame': 60 obs. of  5 variables:
# ..$ pval.up.min: num [1:60] 5.75e-03 1.04e-08 3.61e-03 1.61e-02 1.46e-02 ...
# ..$ min.lfc    : num [1:60] 0.501 1.525 0.601 0.395 0.292 ...
# ..$ exp.max    : num [1:60] 1.079 0.286 2.156 1.184 0.326 ...
# ..$ exp.ct     : num [1:60] 1.581 1.812 2.757 0.909 0.618 ...
# ..$ fract.ct   : num [1:60] 1.14e-04 4.39e-04 3.18e-04 7.57e-05 4.47e-05 ...
# $ AT1                   :'data.frame': 149 obs. of  5 variables:
# ..$ pval.up.min: num [1:149] 5.14e-04 1.07e-02 6.04e-02 3.22e-02 9.12e-06 ...
# ..$ min.lfc    : num [1:149] 0.981 0.799 0.483 0.484 1.101 ...
# ..$ exp.max    : num [1:149] 0.681 0.924 0.705 0.542 0.58 ...
# ..$ exp.ct     : num [1:149] 1.76 1.73 1.21 1.31 3.1 ...
# ..$ fract.ct   : num [1:149] 0.000231 0.000207 0.000123 0.000172 0.000315 ...
# $ Tumor                 :'data.frame': 328 obs. of  5 variables:
# ..$ pval.up.min: num [1:328] 0.0128 0.0112 0.027 0.034 0.0829 ...
# ..$ min.lfc    : num [1:328] 0.2312 0.093 0.0447 0.0613 0.0351 ...
# ..$ exp.max    : num [1:328] 0.232 0.24 2.373 0.373 1.135 ...
# ..$ exp.ct     : num [1:328] 0.568 0.279 0.319 0.267 0.23 ...
# ..$ fract.ct   : num [1:328] 2.02e-05 1.18e-05 1.56e-05 1.47e-05 1.67e-05 ...
# $ AT2                   :'data.frame': 18 obs. of  5 variables:
# ..$ pval.up.min: num [1:18] 7.50e-03 1.06e-10 1.22e-03 9.48e-20 5.03e-04 ...
# ..$ min.lfc    : num [1:18] 0.2842 0.283 0.1433 1.0084 0.0764 ...
# ..$ exp.max    : num [1:18] 0.0763 0.5436 0.3296 1.4399 0.0281 ...
# ..$ exp.ct     : num [1:18] 0.385 2.618 0.801 4.487 0.399 ...
# ..$ fract.ct   : num [1:18] 4.67e-05 4.47e-04 7.82e-05 1.80e-03 3.41e-05 ...
# $ Ciliated              :'data.frame': 322 obs. of  5 variables:
# ..$ pval.up.min: num [1:322] 9.90e-12 4.05e-12 1.62e-02 8.46e-06 7.94e-02 ...
# ..$ min.lfc    : num [1:322] 3.337 3.769 1.068 2.053 0.329 ...
# ..$ exp.max    : num [1:322] 1.1734 0.4173 0.8915 0.3195 0.0703 ...
# ..$ exp.ct     : num [1:322] 4.51 4.19 1.96 2.37 0.4 ...
# ..$ fract.ct   : num [1:322] 1.39e-03 1.16e-03 4.70e-04 4.16e-04 7.24e-05 ...
# $ Skeletal muscle cell  :'data.frame': 269 obs. of  5 variables:
# ..$ pval.up.min: num [1:269] 0.05379 0.00367 0.04529 0.03357 0.00477 ...
# ..$ min.lfc    : num [1:269] 0.833 1.294 0.546 0.867 1.264 ...
# ..$ exp.max    : num [1:269] 5.0807 0.0228 0.1006 1.248 0.057 ...
# ..$ exp.ct     : num [1:269] 5.914 1.317 0.646 1.458 1.321 ...
# ..$ fract.ct   : num [1:269] 0.002198 0.000168 0.000061 0.000198 0.000214 ...
# $ Csf3r+ neutrophil     :'data.frame': 69 obs. of  5 variables:
# ..$ pval.up.min: num [1:69] 2.08e-06 1.08e-02 3.92e-03 1.25e-02 7.77e-02 ...
# ..$ min.lfc    : num [1:69] 0.55 0.288 0.495 0.259 0.165 ...
# ..$ exp.max    : num [1:69] 4.301 0.737 4.064 2.36 4.061 ...
# ..$ exp.ct     : num [1:69] 4.66 0.94 4.64 1.96 4.3 ...
# ..$ fract.ct   : num [1:69] 0.000689 0.000102 0.00074 0.000246 0.000697 ...
# $ Ccl3+ neutrophil      :'data.frame': 26 obs. of  5 variables:
# ..$ pval.up.min: num [1:26] 7.68e-05 9.44e-02 3.05e-02 2.01e-03 5.76e-06 ...
# ..$ min.lfc    : num [1:26] 1.114 0.338 0.503 0.354 2.086 ...
# ..$ exp.max    : num [1:26] 6.61 6.72 5.12 4.6 4.99 ...
# ..$ exp.ct     : num [1:26] 6.25 5.59 5.83 5.34 7.1 ...
# ..$ fract.ct   : num [1:26] 0.00184 0.00141 0.00131 0.0011 0.00391 ...
# $ Siglecf+ neutrophil   :'data.frame': 5 obs. of  5 variables:
# ..$ pval.up.min: num [1:5] 0.059273 0.070901 0.000167 0.000699 0.011169
# ..$ min.lfc    : num [1:5] 0.106 0.131 0.225 0.353 0.356
# ..$ exp.max    : num [1:5] 0.1349 0.0355 0.4801 0.1212 0.9203
# ..$ exp.ct     : num [1:5] 0.323 0.256 1.865 1.21 1.65
# ..$ fract.ct   : num [1:5] 3.11e-05 1.94e-05 2.06e-04 1.83e-04 1.83e-04
# $ B cell                :'data.frame': 10 obs. of  5 variables:
# ..$ pval.up.min: num [1:10] 8.40e-05 1.63e-19 2.21e-08 2.62e-02 1.82e-02 ...
# ..$ min.lfc    : num [1:10] 0.388 0.694 0.506 0.153 0.207 ...
# ..$ exp.max    : num [1:10] 1.78 5.59 1.11 1.25 2.8 ...
# ..$ exp.ct     : num [1:10] 2.169 6.282 1.62 0.986 2.942 ...
# ..$ fract.ct   : num [1:10] 0.000255 0.001641 0.000182 0.000104 0.000442 ...
# $ Plasma cell           :'data.frame': 100 obs. of  5 variables:
# ..$ pval.up.min: num [1:100] 4.84e-09 1.19e-09 1.60e-03 1.07e-02 1.01e-15 ...
# ..$ min.lfc    : num [1:100] 0.2243 0.6787 0.2648 0.0458 0.8318 ...
# ..$ exp.max    : num [1:100] 0.0145 0.9731 0.5125 0.0165 1.6071 ...
# ..$ exp.ct     : num [1:100] 0.2388 1.2797 0.7774 0.0623 2.0198 ...
# ..$ fract.ct   : num [1:100] 2.32e-05 1.02e-04 4.99e-05 4.13e-06 1.73e-04 ...
# $ Basophil              :'data.frame': 124 obs. of  5 variables:
# ..$ pval.up.min: num [1:124] 0.071663 0.003944 0.033857 0.006335 0.000804 ...
# ..$ min.lfc    : num [1:124] 0.19 0.57 0.389 0.744 0.818 ...
# ..$ exp.max    : num [1:124] 0.298 0.393 0.667 1.974 0.572 ...
# ..$ exp.ct     : num [1:124] 0.339 0.963 1.056 2.717 1.39 ...
# ..$ fract.ct   : num [1:124] 2.69e-05 8.36e-05 8.06e-05 3.05e-04 1.34e-04 ...
# $ Platelet              :'data.frame': 334 obs. of  5 variables:
# ..$ pval.up.min: num [1:334] 8.46e-03 3.67e-02 4.34e-03 7.72e-09 4.66e-04 ...
# ..$ min.lfc    : num [1:334] 0.757 0.72 0.625 2.433 1.377 ...
# ..$ exp.max    : num [1:334] 1.051 3.243 0.253 1.44 1.435 ...
# ..$ exp.ct     : num [1:334] 1.266 3.962 0.763 3.873 2.812 ...
# ..$ fract.ct   : num [1:334] 0.000124 0.000705 0.00008 0.000582 0.000429 ...
